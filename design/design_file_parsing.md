# `.cub` ファイルのバリデーション仕様（最終版）

## 1. ファイル全体構成チェック

* **拡張子が `.cub` であること**
* **ファイルが開けること**
* **適切な権限があること**

---

## 2. ヘッダー情報のチェック（設定情報）

ファイル冒頭に存在する設定項目（順不同）：

| 識別子                 | 内容          | チェック内容                                                                   |
| ------------------- | ----------- | ------------------------------------------------------------------------ |
| `NO` `SO` `WE` `EA` | 各方向のテクスチャパス | - 各識別子が1回だけ出現しているか<br>- 半角スペース区切りで指定されているか（識別子の後にはスペースが1つだけ存在すること）<br>- パス文字列が空でないか<br>- テクスチャファイルが `.xpm` 形式であることを確認<br>- 指定されたテクスチャファイルが存在し、読み込み可能か |
| `F` `C`             | 床と天井の色      | - `R,G,B` の形式（カンマがちょうど2つ）<br>- 識別子（F/C）の後にはスペースが1つだけ存在すること<br>- カンマの前後にスペースは許容しない（例: `255,100,0` は正しいが、`255, 100, 0` は不正）<br>- 各値が整数かつ 0〜255 の範囲内か<br>- 各識別子が1回だけ出現しているか |

**空行の扱い**:
* マップ情報以外の部分（NO, SO, WE, EA, F, C）には空行を許容する
* マップ部分では空行は許容しない（マップ中に空行が現れた場合はエラー）
* スペースのみで構成される行はマップの一部として解釈し、マップのバリデーションルールに従って検証する
* ただし、マップの開始前にあるスペースのみの行はマップとして扱わない（スキップされる）

---

## 3. マップ情報のチェック

マップは `.cub` ファイルの **後半に登場する特定の文字で構成されたブロック**

* マップは必ず連続したブロックでなければならない（マップ部分で空行が現れた場合はエラー）
* マップがファイルの最後に配置されていない場合はエラー（マップの後に他の要素や設定がある場合はエラー）

### マップの開始位置の検出

* マップの開始は、行の先頭が `NO`, `SO`, `WE`, `EA`, `F`, `C` 以外の有効な文字（0, 1, N, S, E, W のいずれか）から始まる行とする
* マップ開始時点で、必須の6つの情報（NO, SO, WE, EA, F, C）が全て設定されていない場合はエラーとする

### マップ行の事前処理

* 各行の長さを最大幅に合わせて **`*`（仮）で埋めて揃える**
* `*` は**無効なマス**として扱い、マップ検証時には「スペース」と同様の扱いとする（つまり、`*` に隣接するプレイ可能エリアはマップが閉じられていないとみなす）

### マップ中の文字の種類

使用可能な文字は以下の通り：

| 文字                 | 意味                  |
| ------------------ | ------------------- |
| `1`                | 壁（通れない）             |
| `0`                | 空間（通れる）             |
| `N`, `S`, `E`, `W` | プレイヤーの開始位置（向きつき）    |
| 空白 `' '`           | 無効エリア（マップ外の余白として許容） |
| `*`                | パディング（行の長さ揃え用）      |

---

### マップチェック内容

| チェック項目             | 説明                                                          |
| ------------------ | ----------------------------------------------------------- |
| **使用文字の妥当性**       | 上記の有効な文字だけを含む                                               |
| **プレイヤー開始位置が1つだけ** | `N,S,E,W` のいずれかが **ちょうど1つだけ** 含まれる                          |
| **マップが完全に囲まれている**  | すべてのプレイ可能エリア(`0`, `N`, `S`, `E`, `W`)の上下左右は、必ず壁(`1`)または別のプレイ可能エリアに接していること。スペースや `*` に接している場合はマップが閉じられていないとみなす |
| **マップは矩形状**        | 全ての行が同じ長さになるよう `*` で調整済みであること（整形された状態でチェック実施）               |

---

## 4. マップデータの格納方法

* マップデータは char 型の二次元配列（二重配列）として格納する
* 各行は NULL 終端とする

---

## 5. エラー処理

### エラーケースと表示メッセージ

| エラーケース | 表示メッセージ |
| ----------- | ------------ |
| 引数の数が誤り | "Error\nInvalid number of arguments" |
| ファイル名が不正 | "Error\nInvalid file name" |
| ファイルが開けない | "Error\nCannot open file" |
| テクスチャファイルが存在しない | "Error\nTexture file not found: [パス]" |
| テクスチャファイルの拡張子が不正 | "Error\nInvalid texture file format (must be .xpm): [パス]" |
| テクスチャが読み込めない | "Error\nCannot load texture: [パス]" |
| 識別子が重複して出現 | "Error\nDuplicate identifier: [識別子]" |
| 色指定のフォーマットが不正 | "Error\nInvalid color format: [指定値]" |
| 色の値が範囲外 | "Error\nColor value out of range: [指定値]" |
| マップが壁で囲まれていない | "Error\nMap is not surrounded by walls at position (x,y)" |
| プレイヤーの開始位置が存在しない | "Error\nNo player starting position" |
| プレイヤーの開始位置が複数ある | "Error\nMultiple player starting positions" |
| マップに無効な文字がある | "Error\nInvalid character in map: [文字] at position (x,y)" |
| 必須要素が不足している | "Error\nMissing required element: [識別子]" |

### エラー検出時のプログラム終了方法

* 確保済みのメモリを全て `free()` 関数で解放する
* エラーメッセージを標準エラー出力に表示する
* `exit(1)` でプログラムを終了する